##https://docs.github.com/en/actions/reference/workflows-and-actions/contexts#context-availability
name: Using Reusable Workflow
on:
  push
  # branches:
  #   - main
  #   - master
  #   - raj
  #   - rohini
jobs:
 lint:
  continue-on-error: true
  runs-on: ubuntu-latest
  steps:
    - name: Get code
      uses: actions/checkout@v4
    - name: Cache dependencies
      id: cache
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: deps-node-modules-${{ hashFiles('**/package-lock.json') }}
        restore-keys: deps-node-modules-
    - name: Install dependencies
      run: npm ci
    - name: Lint code
      run: npm run lint || echo "::warning::Lint failed but continuing"
    - name: Warn if lint fails
      if: failure()
      run: echo "::warning::Lint failed but continuing due to continue-on-error"

 test:
    runs-on: ubuntu-latest
    steps:
      - name: Get code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: npm ci
      - name: Test code
        id: run-tests
        run: npm run test
      - name: Upload test report
        if: failure() && steps.run-tests.outcome == 'failure' ## This step is condition for next step only runs if this step fails   ###https://docs.github.com/en/actions/reference/contexts-reference all the refrence contexts and syntax can be found here
        ##faliure() always returns true if any job or functions fails, or previous step fails, sucess() reuts true when none of the previous step fails, always() returns true no matter what the previous step returns, cancelled() retuns true when the workflow is cancelled, success() returns true when the previous step is successful
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test.json
 build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Get code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: npm ci
      - name: Build website
        id: build-website
        run: npm run build
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: dist
 deploy:
    needs: build
    uses: ./.github/workflows/reusable.yaml ## This is the reusable workflow that will be called by this job
    with:
      atifact-name: dist-files ## This is the name of the artifact to download, it should match the name of the artifact uploaded in the build job
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} ## This is the GitHub token that will be used to authenticate the workflow, it is required for the reusable workflow to work
      ## we are giving  ${{ secrets.GITHUB_TOKEN }} as input to the workflow, this will be used to authenticate the workflow, the refrence calls for this input is in the reusable workflow file, it is used to authenticate the workflow
 report:
    needs: [lint, deploy]
    if: failure() ### This job will only run if any of the previous jobs fail because faliure() returns true if any of the previous jobs fail
    runs-on: ubuntu-latest
    steps:
      - name: Output infroamtion
        run: |
          echo "Linting completed successfully."
          echo "Testing completed successfully."
          echo "Build completed successfully."
          echo "Deployment completed successfully."
          echo "${{toJSON(github)}}"
